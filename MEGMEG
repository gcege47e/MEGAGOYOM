import telebot
import sqlite3
import os
import json
from flask import Flask, request
from telebot import types
import datetime
import jdatetime
from persian import convert_fa_numbers
import random

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
API_TOKEN = '8134200098:AAGGapErG9F0ek0lAEdrI53E5gzPDcObTQM'
ADMIN_ID = 7385601641
WEBHOOK_URL = os.getenv('WEBHOOK_URL', '') + f'/{API_TOKEN}' if os.getenv('WEBHOOK_URL') else None

bot = telebot.TeleBot(API_TOKEN)
app = Flask(__name__)

# Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡
os.makedirs("data", exist_ok=True)
DB_PATH = "data/goyom_bot.db"

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
conn = sqlite3.connect(DB_PATH, check_same_thread=False)
cursor = conn.cursor()

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„
cursor.execute('''CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    age INTEGER,
    gender TEXT,
    points INTEGER DEFAULT 0,
    random_id INTEGER UNIQUE,
    last_active DATE
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS ads(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    title TEXT,
    description TEXT,
    price TEXT,
    address TEXT,
    category_main TEXT,
    category_sub TEXT,
    photo_id TEXT,
    contact TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS shops(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT,
    description TEXT,
    address TEXT,
    category_main TEXT,
    category_sub TEXT,
    photo_id TEXT,
    contact TEXT,
    admin_id INTEGER,
    owner_id INTEGER,
    seller_username TEXT,
    seller_age INTEGER,
    seller_gender TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS shop_ratings(
    shop_id INTEGER,
    user_id INTEGER,
    rating INTEGER,
    PRIMARY KEY (shop_id, user_id)
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS admin_content(
    section TEXT PRIMARY KEY,
    content TEXT
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS jokes(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    joke_text TEXT
)''')

cursor.execute('''CREATE TABLE IF NOT EXISTS user_states(
    user_id INTEGER PRIMARY KEY,
    state TEXT,
    data TEXT
)''')

conn.commit()

# Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¢Ú¯Ù‡ÛŒ
AD_CATEGORIES = {
    "ğŸ¡ Ø§Ù…Ù„Ø§Ú© Ùˆ Ù…Ø³ØªØºÙ„Ø§Øª ğŸ¡": ["ğŸ¢ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†", "ğŸ  Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ø®Ø§Ù†Ù‡ Ùˆ ÙˆÛŒÙ„Ø§", "ğŸ›– Ø²Ù…ÛŒÙ† Ùˆ Ú©Ù„Ù†Ú¯ÛŒ", "ğŸ“¦ Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø³Ú©ÙˆÙ†ÛŒ"],
    "ğŸš— ÙˆØ³Ø§ÛŒÙ„ Ù†Ù‚Ù„ÛŒÙ‡ ğŸš—": ["ğŸš˜ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ø®ÙˆØ¯Ø±Ùˆ", "ğŸ›µ Ù…ÙˆØªÙˆØ± Ø³ÛŒÚ©Ù„Øª", "ğŸšŒ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ†"],
    "ğŸ›’ Ù„ÙˆØ§Ø²Ù… Ø´Ø®ØµÛŒ Ùˆ Ø®Ø§Ù†Ú¯ÛŒ ğŸ›’": ["ğŸ› ÙˆØ³Ø§ÛŒÙ„ Ø®Ø§Ù†Ù‡", "ğŸ³ ÙˆØ³Ø§ÛŒÙ„ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡", "ğŸª‘ Ù…Ø¨Ù„Ù…Ø§Ù†"],
    "ğŸ‘” Ù¾ÙˆØ´Ø§Ú© Ùˆ Ù…Ø¯ ğŸ‘”": ["ğŸ‘— Ù¾ÙˆØ´Ø§Ú© Ø²Ù†Ø§Ù†Ù‡", "ğŸ‘” Ù¾ÙˆØ´Ø§Ú© Ù…Ø±Ø¯Ø§Ù†Ù‡", "âŒš Ø§Ú©Ø³Ø³ÙˆØ±ÛŒ"],
    "ğŸ§¸ Ø§Ø³Ø¨Ø§Ø¨â€ŒØ¨Ø§Ø²ÛŒ Ùˆ Ú©ÙˆØ¯Ú© ğŸ§¸": ["ğŸ§¸ Ø§Ø³Ø¨Ø§Ø¨ Ø¨Ø§Ø²ÛŒ", "ğŸ¼ Ù„ÙˆØ§Ø²Ù… Ù†ÙˆØ²Ø§Ø¯", "ğŸš¼ ÙˆØ³Ø§ÛŒÙ„ Ú©ÙˆØ¯Ú©"],
    "ğŸ–¥ï¸ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ© Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„ ğŸ–¥ï¸": ["ğŸ“± Ù…ÙˆØ¨Ø§ÛŒÙ„", "ğŸ’» Ù„Ù¾â€ŒØªØ§Ù¾ Ùˆ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±", "ğŸ§ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ"],
    "ğŸ‹ï¸â€â™‚ï¸ ÙˆØ±Ø²Ø´ Ùˆ Ø³Ø±Ú¯Ø±Ù…ÛŒ ğŸ‹ï¸â€â™‚ï¸": ["ğŸ® Ø¨Ø§Ø²ÛŒ Ùˆ Ú©Ù†Ø³ÙˆÙ„", "âš½ ÙˆØ³Ø§ÛŒÙ„ ÙˆØ±Ø²Ø´ÛŒ", "ğŸ¤ Ø³Ø§Ø²Ù‡Ø§ÛŒ Ù…ÙˆØ³ÛŒÙ‚ÛŒ"],
    "ğŸ› ï¸ Ø§Ø¨Ø²Ø§Ø± Ùˆ ØªØ¬Ù‡ÛŒØ²Ø§Øª ğŸ› ï¸": ["ğŸ› ï¸ Ø§Ø¨Ø²Ø§Ø± ÙÙ†ÛŒ", "ğŸ”§ ØªØ¬Ù‡ÛŒØ²Ø§Øª ØµÙ†Ø¹ØªÛŒ", "âš¡ Ù„ÙˆØ§Ø²Ù… Ø¨Ø±Ù‚ÛŒ"],
    "ğŸ¾ Ø­ÛŒÙˆØ§Ù†Ø§Øª Ø®Ø§Ù†Ú¯ÛŒ ğŸ¾": ["ğŸ¶ Ø³Ú¯", "ğŸ± Ú¯Ø±Ø¨Ù‡", "ğŸ  Ø­ÛŒÙˆØ§Ù†Ø§Øª Ø¯ÛŒÚ¯Ø±"],
    "ğŸ“ Ø®Ø¯Ù…Ø§Øª Ø¢Ù…ÙˆØ²Ø´ÛŒ ğŸ“": ["ğŸ“š ØªØ¯Ø±ÛŒØ³ Ø®ØµÙˆØµÛŒ", "ğŸ¨ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù‡Ù†Ø±ÛŒ", "ğŸ’» Ø¢Ù…ÙˆØ²Ø´ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±"],
    "ğŸ‰ Ø®Ø¯Ù…Ø§Øª Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… ğŸ‰": ["ğŸ§‘â€ğŸ’¼ Ø§Ø³ØªØ®Ø¯Ø§Ù…", "ğŸ› ï¸ Ø®Ø¯Ù…Ø§Øª ÙÙ†ÛŒ", "ğŸ´ Ø®Ø¯Ù…Ø§Øª ØºØ°Ø§ÛŒÛŒ"],
    "âœˆï¸ Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ Ùˆ Ø³ÙØ± âœˆï¸": ["ğŸ¨ Ø±Ø²Ø±Ùˆ Ù‡ØªÙ„", "âœˆï¸ Ø¨Ù„ÛŒØ· Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§", "ğŸ—ºï¸ ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø³Ø§ÙØ±ØªÛŒ"],
    "ğŸ Ù‡Ø¯Ø§ÛŒØ§ Ùˆ Ù‡Ù†Ø± ğŸ": ["ğŸ¨ ØµÙ†Ø§ÛŒØ¹ Ø¯Ø³ØªÛŒ", "ğŸ’ Ú¯Ù„ Ùˆ Ù‡Ø¯ÛŒÙ‡", "ğŸ–¼ï¸ ØªØ§Ø¨Ù„ÙˆÙ‡Ø§ÛŒ Ù†Ù‚Ø§Ø´ÛŒ"],
    "ğŸ½ï¸ Ø±Ø³ØªÙˆØ±Ø§Ù† Ùˆ ØºØ°Ø§ ğŸ½ï¸": ["ğŸ• ÙØ³Øª ÙÙˆØ¯", "ğŸ° Ù‚Ù†Ø§Ø¯ÛŒ", "ğŸ¥— ØºØ°Ø§ÛŒ Ù…Ø­Ù„ÛŒ"],
    "ğŸ’¼ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ùˆ ØªØ¨Ù„ÛŒØºØ§Øª ğŸ’¼": ["ğŸ“Š Ù…Ø´Ø§ÙˆØ±Ù‡ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±", "ğŸ“¢ ØªØ¨Ù„ÛŒØºØ§Øª", "ğŸŒ Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§ÛŒØª"]
}

# Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ØºØ§Ø²Ù‡
SHOP_CATEGORIES = {
    "ğŸ¥– Ù…ÙˆØ§Ø¯ ØºØ°Ø§ÛŒÛŒ Ùˆ Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øªâ€ŒÙ‡Ø§ ğŸ¥–": ["ğŸ›’ Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øª", "ğŸ¥© Ù‚ØµØ§Ø¨ÛŒ", "ğŸ Ù…ÛŒÙˆÙ‡â€ŒÙØ±ÙˆØ´ÛŒ"],
    "ğŸ§¸ Ø§Ø³Ø¨Ø§Ø¨â€ŒØ¨Ø§Ø²ÛŒ Ùˆ Ú©ÙˆØ¯Ú© ğŸ§¸": ["ğŸ§¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ø³Ø¨Ø§Ø¨ Ø¨Ø§Ø²ÛŒ", "ğŸ‘¶ Ù„ÙˆØ§Ø²Ù… Ù†ÙˆØ²Ø§Ø¯", "ğŸš¼ Ù„Ø¨Ø§Ø³ Ú©ÙˆØ¯Ú©"],
    "ğŸ‘• Ù¾ÙˆØ´Ø§Ú© Ùˆ Ù„Ø¨Ø§Ø³ ğŸ‘•": ["ğŸ‘— Ù¾ÙˆØ´Ø§Ú© Ø²Ù†Ø§Ù†Ù‡", "ğŸ‘” Ù¾ÙˆØ´Ø§Ú© Ù…Ø±Ø¯Ø§Ù†Ù‡", "ğŸ‘• Ù¾ÙˆØ´Ø§Ú© ÙˆØ±Ø²Ø´ÛŒ"],
    "ğŸ‘Ÿ Ú©ÙØ´ Ùˆ Ú©ÛŒÙ ğŸ‘Ÿ": ["ğŸ‘ Ú©ÙØ´ Ù…Ø±Ø¯Ø§Ù†Ù‡", "ğŸ‘  Ú©ÙØ´ Ø²Ù†Ø§Ù†Ù‡", "ğŸ‘œ Ú©ÛŒÙ Ùˆ Ú†Ù…Ø¯Ø§Ù†"],
    "ğŸ–¥ï¸ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ© Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„ ğŸ–¥ï¸": ["ğŸ“± ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„", "ğŸ’» ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù„Ù¾â€ŒØªØ§Ù¾", "ğŸ§ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ Ø§Ù„Ú©ØªØ±ÙˆÙ†ik"],
    "ğŸ  Ù„ÙˆØ§Ø²Ù… Ø®Ø§Ù†Ú¯ÛŒ Ùˆ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡ ğŸ ": ["ğŸ³ Ù„ÙˆØ§Ø²Ù… Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡", "ğŸ› Ù„ÙˆØ§Ø²Ù… Ø®ÙˆØ§Ø¨", "ğŸ§¹ Ù„ÙˆØ§Ø²Ù… Ù†Ø¸Ø§ÙØªÛŒ"],
    "ğŸ’„ Ø¢Ø±Ø§ÛŒØ´ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´ØªÛŒ ğŸ’„": ["ğŸ’… Ù„ÙˆØ§Ø²Ù… Ø¢Ø±Ø§ÛŒØ´ÛŒ", "ğŸ§´ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ù‡Ø¯Ø§Ø´ØªÛŒ", "ğŸ§¼ Ø¹Ø·Ø± Ùˆ Ø§Ø¯Ú©Ù„Ù†"],
    "ğŸ“š Ú©ØªØ§Ø¨ Ùˆ Ù†ÙˆØ´Øªâ€ŒØ§ÙØ²Ø§Ø± ğŸ“š": ["ğŸ“– Ú©ØªØ§Ø¨ÙØ±ÙˆØ´ÛŒ", "ğŸ–Šï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù†ÙˆØ´Øª Ø§ÙØ²Ø§Ø±", "ğŸ¨ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù‡Ù†Ø±ÛŒ"],
    "ğŸ› ï¸ Ø§Ø¨Ø²Ø§Ø± Ùˆ ÛŒØ±Ø§Ù‚ Ø¢Ù„Ø§Øª ğŸ› ï¸": ["ğŸ”§ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ø¨Ø²Ø§Ø±", "âš™ï¸ ÛŒØ±Ø§Ù‚ Ø¢Ù„Ø§Øª", "ğŸª› Ø§Ø¨Ø²Ø§Ø± Ø¨Ø±Ù‚ÛŒ"],
    "ğŸª´ Ú¯Ù„ Ùˆ Ú¯ÛŒØ§Ù‡ ğŸª´": ["ğŸ’ Ú¯Ù„ ÙØ±ÙˆØ´ÛŒ", "ğŸŒ¿ Ú¯ÛŒØ§Ù‡Ø§Ù† Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ", "ğŸº Ú¯Ù„Ø¯Ø§Ù† Ùˆ Ù„ÙˆØ§Ø²Ù… Ø¨Ø§ØºØ¨Ø§Ù†ÛŒ"],
    "ğŸ‹ï¸â€â™‚ï¸ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ùˆ Ù„ÙˆØ§Ø²Ù… ÙˆØ±Ø²Ø´ÛŒ ğŸ‹ï¸â€â™‚ï¸": ["ğŸ‹ï¸â€â™‚ï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ÙˆØ±Ø²Ø´ÛŒ", "ğŸš´ Ù„ÙˆØ§Ø²Ù… Ø¯ÙˆÚ†Ø±Ø®Ù‡", "ğŸ½ Ù„Ø¨Ø§Ø³ ÙˆØ±Ø²Ø´ÛŒ"],
    "ğŸï¸ Ù…ÙˆØªÙˆØ± Ùˆ Ø¯ÙˆÚ†Ø±Ø®Ù‡ Ùˆ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ ğŸï¸": ["ğŸï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…ÙˆØªÙˆØ±", "ğŸš² ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯ÙˆÚ†Ø±Ø®Ù‡", "ğŸ›¡ï¸ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ Ù…ÙˆØªÙˆØ±"],
    "ğŸš— Ù„ÙˆØ§Ø²Ù… Ø®ÙˆØ¯Ø±Ùˆ Ùˆ ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ ğŸš—": ["ğŸ”§ ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡ Ø®ÙˆØ¯Ø±Ùˆ", "ğŸš˜ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù„ÙˆØ§Ø²Ù… Ø®ÙˆØ¯Ø±Ùˆ", "ğŸ› ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù„Ø§Ø³ØªÛŒÚ©"],
    "ğŸ¨ Ø±Ø³ØªÙˆØ±Ø§Ù† Ùˆ Ú©Ø§ÙÛŒâ€ŒØ´Ø§Ù¾ ğŸ¨": ["ğŸ• Ø±Ø³ØªÙˆØ±Ø§Ù†", "â˜• Ú©Ø§ÙÛŒ Ø´Ø§Ù¾", "ğŸ° Ù‚Ù†Ø§Ø¯ÛŒ"],
    "ğŸ® Ú¯ÛŒÙ… Ùˆ Ø³Ø±Ú¯Ø±Ù…ÛŒ ğŸ®": ["ğŸ® ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§Ø²ÛŒ", "ğŸ² ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø³Ø±Ú¯Ø±Ù…ÛŒ", "ğŸ¯ Ø§Ø³Ø¨Ø§Ø¨ Ø¨Ø§Ø²ÛŒ ÙÚ©Ø±ÛŒ"]
}

# Ú©ÛŒØ¨ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
def get_main_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    items = [
        types.KeyboardButton("ğŸ“¢ Ø§Ø®Ø¨Ø§Ø± Ú¯ÙˆÛŒÙ… ğŸ“¢"),
        types.KeyboardButton("ğŸŒ¦ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ğŸŒ¦"),
        types.KeyboardButton("ğŸ› Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ… ğŸ›"),
        types.KeyboardButton("ğŸ‰ Ø³Ø±Ú¯Ø±Ù…ÛŒ Ùˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡ ğŸ‰"),
        types.KeyboardButton("ğŸ˜‚ Ø·Ù†Ø² Ùˆ Ø®Ø§Ø·Ø±Ø§Øª ğŸ˜‚"),
        types.KeyboardButton("âš½ ÙˆØ±Ø²Ø´ Ùˆ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ âš½"),
        types.KeyboardButton("ğŸ—³ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ğŸ—³"),
        types.KeyboardButton("ğŸ“ Ø®Ø¯Ù…Ø§Øª Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… ğŸ“"),
        types.KeyboardButton("ğŸ“ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù† ğŸ“"),
        types.KeyboardButton("ğŸª Ù…ØºØ§Ø²Ù‡ Ù‡Ø§ ğŸª")
    ]
    keyboard.add(*items)
    return keyboard

def get_admin_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    items = [
        types.KeyboardButton("ğŸ“¢ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø¨Ø± ğŸ“¢"),
        types.KeyboardButton("ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ±Ø²Ø´ ğŸ“"),
        types.KeyboardButton("ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø¯Ù…Ø§Øª ğŸ“"),
        types.KeyboardButton("ğŸ‰ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ğŸ‰"),
        types.KeyboardButton("ğŸ—³ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ğŸ—³"),
        types.KeyboardButton("ğŸª Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ ğŸª"),
        types.KeyboardButton("ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ ğŸ‘¥"),
        types.KeyboardButton("â¬…ï¸ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â¬…ï¸")
    ]
    keyboard.add(*items)
    return keyboard

def get_back_to_admin_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª")
    return keyboard

def get_back_to_main_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_ad_main_categories_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    for main_cat in AD_CATEGORIES.keys():
        keyboard.add(main_cat)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ…")
    return keyboard

def get_ad_sub_categories_keyboard(main_category):
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    for sub_cat in AD_CATEGORIES[main_category]:
        keyboard.add(sub_cat)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_shop_main_categories_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    for main_cat in SHOP_CATEGORIES.keys():
        keyboard.add(main_cat)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ØºØ§Ø²Ù‡ Ù‡Ø§")
    return keyboard

def get_shop_sub_categories_keyboard(main_category):
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    for sub_cat in SHOP_CATEGORIES[main_category]:
        keyboard.add(sub_cat)
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_profile_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ âœï¸", "â­ Ú¯ÙˆÛŒÙ…ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± â­")
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_edit_profile_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("âœï¸ ØªØºÛŒÛŒØ± Ø§Ø³Ù…", "âœï¸ ØªØºÛŒÛŒØ± Ø³Ù†")
    keyboard.add("âœï¸ ØªØºÛŒÛŒØ± Ø¬Ù†Ø³ÛŒØª", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„")
    return keyboard

def get_gender_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("ğŸ‘¦ Ù¾Ø³Ø±", "ğŸ‘§ Ø¯Ø®ØªØ±")
    return keyboard

def get_ads_management_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§", "â• Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ú¯Ù‡ÛŒ")
    keyboard.add("ğŸ“„ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_shops_management_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§", "â• Ø§ÙØ²ÙˆØ¯Ù† Ù…ØºØ§Ø²Ù‡")
    keyboard.add("ğŸ“„ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ")
    return keyboard

def get_jokes_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("ğŸ“œ Ù„ÛŒØ³Øª Ø·Ù†Ø²Ù‡Ø§", "â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù†Ø²")
    keyboard.add("ğŸ“„ Ø·Ù†Ø²Ù‡Ø§ÛŒ Ù…Ù†", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ")
    return keyboard

# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
def get_user_data(user_id):
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    return cursor.fetchone()

def set_user_state(user_id, state, data=None):
    cursor.execute("INSERT OR REPLACE INTO user_states (user_id, state, data) VALUES (?, ?, ?)",
                   (user_id, state, json.dumps(data) if data else None))
    conn.commit()

def get_user_state(user_id):
    cursor.execute("SELECT state, data FROM user_states WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    if result:
        state, data = result
        return state, json.loads(data) if data else None
    return None, None

def update_user_points(user_id, points_to_add=1):
    cursor.execute("UPDATE users SET points = points + ? WHERE user_id = ?", (points_to_add, user_id))
    conn.commit()

def give_daily_bonus(user_id):
    today = datetime.date.today()
    cursor.execute("SELECT last_active FROM users WHERE user_id = ?", (user_id,))
    last_active = cursor.fetchone()
    if not last_active or not last_active[0] or last_active[0] != str(today):
        update_user_points(user_id, 5)
        cursor.execute("UPDATE users SET last_active = ? WHERE user_id = ?", (str(today), user_id))
        conn.commit()

def notify_all_users(section):
    cursor.execute("SELECT user_id FROM users")
    users = cursor.fetchall()
    message_text = f"ğŸ“¢ Ø¨Ù‡ Ø¨Ø®Ø´ '{section}' Ù…ÙˆØ¶ÙˆØ¹ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø®Ø´ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯."
    for user in users:
        try:
            bot.send_message(user[0], message_text, reply_markup=get_main_keyboard())
        except:
            pass

# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)
    if user_data:
        bot.send_message(user_id, "ğŸ‘‹ Ø³Ù„Ø§Ù…! Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", reply_markup=get_main_keyboard())
        give_daily_bonus(user_id)
    else:
        set_user_state(user_id, 'awaiting_username')
        bot.send_message(user_id, "ğŸŒŸ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ø±Ø¨Ø§Øª 'Ù…Ú¯Ø§ Ú¯ÙˆÛŒÙ…'!\n\nÙ„Ø·ÙØ§Ù‹ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(commands=['admin'])
def send_admin_panel(message):
    user_id = message.from_user.id
    if user_id == ADMIN_ID:
        bot.send_message(user_id, "ğŸ‘¨â€ğŸ’¼ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=get_admin_keyboard())
    else:
        bot.send_message(user_id, "â›” Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†Ø¯Ø§Ø±ÛŒØ¯.")

@bot.message_handler(func=lambda message: message.text == "â¬…ï¸ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†" and message.from_user.id == ADMIN_ID)
def return_to_main_menu(message):
    bot.send_message(message.from_user.id, "ğŸ  Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª" and message.from_user.id == ADMIN_ID)
def return_to_admin_panel(message):
    bot.send_message(message.from_user.id, "ğŸ‘¨â€ğŸ’¼ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.", reply_markup=get_admin_keyboard())

# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù…
@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_username')
def get_username(message):
    user_id = message.from_user.id
    username = message.text.strip()
    if not username:
        bot.send_message(user_id, "âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_age', {'reg_username': username})
    bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ Ø³Ù† Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (13-70):", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_age')
def get_age(message):
    user_id = message.from_user.id
    try:
        age = int(message.text)
        if 13 <= age <= 70:
            state, data = get_user_state(user_id)
            data['reg_age'] = age
            set_user_state(user_id, 'awaiting_gender', data)
            keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True, one_time_keyboard=True)
            keyboard.add("ğŸ‘¦ Ù¾Ø³Ø±", "ğŸ‘§ Ø¯Ø®ØªØ±")
            bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ Ø¬Ù†Ø³ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=keyboard)
        else:
            bot.send_message(user_id, "âš ï¸ Ø³Ù† Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 13 ØªØ§ 70 Ø¨Ø§Ø´Ø¯:")
    except ValueError:
        bot.send_message(user_id, "âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_gender')
def get_gender(message):
    user_id = message.from_user.id
    gender = message.text
    if gender in ["ğŸ‘¦ Ù¾Ø³Ø±", "ğŸ‘§ Ø¯Ø®ØªØ±"]:
        state, data = get_user_state(user_id)
        username = data['reg_username']
        age = data['reg_age']
        gender_text = "Ù¾Ø³Ø±" if "Ù¾Ø³Ø±" in gender else "Ø¯Ø®ØªØ±"
        rand_id = random.randint(100000, 999999)
        cursor.execute("INSERT INTO users (user_id, username, age, gender, random_id, last_active) VALUES (?, ?, ?, ?, ?, ?)",
                       (user_id, username, age, gender_text, rand_id, str(datetime.date.today())))
        conn.commit()
        cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
        conn.commit()
        bot.send_message(user_id, "âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!", reply_markup=get_main_keyboard())
        update_user_points(user_id, 5)
    else:
        bot.send_message(user_id, "âš ï¸ Ù„Ø·ÙØ§Ù‹ 'Ù¾Ø³Ø±' ÛŒØ§ 'Ø¯Ø®ØªØ±' Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_gender_keyboard())

# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
@bot.message_handler(func=lambda message: message.text in [
    "ğŸ“¢ Ø§Ø®Ø¨Ø§Ø± Ú¯ÙˆÛŒÙ… ğŸ“¢", "ğŸŒ¦ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ğŸŒ¦", "ğŸ› Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ… ğŸ›", "ğŸ‰ Ø³Ø±Ú¯Ø±Ù…ÛŒ Ùˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡ ğŸ‰",
    "ğŸ˜‚ Ø·Ù†Ø² Ùˆ Ø®Ø§Ø·Ø±Ø§Øª ğŸ˜‚", "âš½ ÙˆØ±Ø²Ø´ Ùˆ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ âš½", "ğŸ—³ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ğŸ—³", "ğŸ“ Ø®Ø¯Ù…Ø§Øª Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… ğŸ“",
    "ğŸ“ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù† ğŸ“", "ğŸª Ù…ØºØ§Ø²Ù‡ Ù‡Ø§ ğŸª"
])
def handle_main_menu(message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)
    if not user_data:
        send_welcome(message)
        return
    give_daily_bonus(user_id)

    if message.text == "ğŸ“¢ Ø§Ø®Ø¨Ø§Ø± Ú¯ÙˆÛŒÙ… ğŸ“¢":
        show_admin_content(user_id, "Ø§Ø®Ø¨Ø§Ø±")
    elif message.text == "ğŸŒ¦ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ğŸŒ¦":
        today = jdatetime.date.today()
        bot.send_message(user_id, f"ğŸ“… Ø§Ù…Ø±ÙˆØ²: {today.strftime('%A %d %B %Y')}", reply_markup=get_main_keyboard())
    elif message.text == "ğŸ› Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ… ğŸ›":
        handle_divar(message)
    elif message.text == "ğŸ‰ Ø³Ø±Ú¯Ø±Ù…ÛŒ Ùˆ Ù…Ø³Ø§Ø¨Ù‚Ù‡ ğŸ‰":
        bot.send_message(user_id, "ğŸ¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª.", reply_markup=get_main_keyboard())
    elif message.text == "ğŸ˜‚ Ø·Ù†Ø² Ùˆ Ø®Ø§Ø·Ø±Ø§Øª ğŸ˜‚":
        handle_jokes(message)
    elif message.text == "âš½ ÙˆØ±Ø²Ø´ Ùˆ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ âš½":
        show_admin_content(user_id, "ÙˆØ±Ø²Ø´")
    elif message.text == "ğŸ—³ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ ğŸ—³":
        bot.send_message(user_id, "ğŸ“Š Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª.", reply_markup=get_main_keyboard())
    elif message.text == "ğŸ“ Ø®Ø¯Ù…Ø§Øª Ùˆ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… ğŸ“":
        show_admin_content(user_id, "Ø®Ø¯Ù…Ø§Øª")
    elif message.text == "ğŸ“ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù† ğŸ“":
        show_profile(message)
    elif message.text == "ğŸª Ù…ØºØ§Ø²Ù‡ Ù‡Ø§ ğŸª":
        handle_shops(message)

# Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
def show_admin_content(chat_id, section):
    cursor.execute("SELECT content FROM admin_content WHERE section = ?", (section,))
    content = cursor.fetchone()
    if content:
        bot.send_message(chat_id, content[0], parse_mode='Markdown')
    else:
        bot.send_message(chat_id, f"â„¹ï¸ Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ '{section}' ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")

@bot.message_handler(func=lambda message: message.text == "ğŸ“¢ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø¨Ø± ğŸ“¢" and message.from_user.id == ADMIN_ID)
def add_news_start(message):
    set_user_state(ADMIN_ID, 'awaiting_news_content')
    bot.send_message(ADMIN_ID, "ğŸ“ Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø®Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_news_content' and message.from_user.id == ADMIN_ID)
def save_news_content(message):
    user_id = message.from_user.id
    news_content = message.text
    cursor.execute("INSERT OR REPLACE INTO admin_content (section, content) VALUES (?, ?)", ("Ø§Ø®Ø¨Ø§Ø±", news_content))
    conn.commit()
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()
    
    # Ø§Ø±Ø³Ø§Ù„ Ø®Ø¨Ø± Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    cursor.execute("SELECT user_id FROM users")
    users = cursor.fetchall()
    for user in users:
        try:
            bot.send_message(user[0], f"ğŸ“¢ Ø®Ø¨Ø± Ø¬Ø¯ÛŒØ¯:\n\n{news_content}", parse_mode='Markdown')
        except:
            pass
    
    bot.send_message(ADMIN_ID, "âœ… Ø®Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.", reply_markup=get_admin_keyboard())

# Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
@bot.message_handler(func=lambda message: message.text == "ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ ğŸ‘¥" and message.from_user.id == ADMIN_ID)
def show_active_users(message):
    cursor.execute("SELECT COUNT(*) FROM users")
    total = cursor.fetchone()[0]
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    keyboard.add("ğŸ‘¦ Ù¾Ø³Ø±Ù‡Ø§", "ğŸ‘§ Ø¯Ø®ØªØ±Ù‡Ø§")
    keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª")
    bot.send_message(message.from_user.id, f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {total}", reply_markup=keyboard)

@bot.message_handler(func=lambda message: message.text in ["ğŸ‘¦ Ù¾Ø³Ø±Ù‡Ø§", "ğŸ‘§ Ø¯Ø®ØªØ±Ù‡Ø§"] and message.from_user.id == ADMIN_ID)
def list_users_by_gender(message):
    gender = "Ù¾Ø³Ø±" if "Ù¾Ø³Ø±" in message.text else "Ø¯Ø®ØªØ±"
    cursor.execute("SELECT username, age, points, random_id FROM users WHERE gender = ?", (gender,))
    users = cursor.fetchall()
    if users:
        response = f"ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† {gender}:\n\n"
        for user in users:
            response += f"ğŸ‘¤ Ù†Ø§Ù…: {user[0]}\nğŸ‚ Ø³Ù†: {user[1]}\nâ­ Ø§Ù…ØªÛŒØ§Ø²: {user[2]}\nğŸ”¢ Ø´Ù†Ø§Ø³Ù‡: {user[3]}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    else:
        response = f"â„¹ï¸ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø¬Ù†Ø³ÛŒØª {gender} ÛŒØ§ÙØª Ù†Ø´Ø¯."
    bot.send_message(message.from_user.id, response, reply_markup=get_admin_keyboard())

# Ø¨Ø®Ø´ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ…)
def handle_divar(message):
    bot.send_message(message.chat.id, "ğŸ› Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=get_ads_management_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§")
def show_ad_main_categories(message):
    bot.send_message(message.chat.id, "ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_ad_main_categories_keyboard())
    set_user_state(message.from_user.id, 'awaiting_ad_main_cat_view')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_main_cat_view' and message.text in AD_CATEGORIES)
def show_ad_sub_categories_view(message):
    main_cat = message.text
    bot.send_message(message.chat.id, f"ğŸ“ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ '{main_cat}' Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.\nØ²ÛŒØ± Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_ad_sub_categories_keyboard(main_cat))
    set_user_state(message.from_user.id, f'awaiting_ad_sub_cat_view_{main_cat}')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_ad_sub_cat_view_'))
def show_ads_in_sub_cat(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    main_cat = state.split('_')[-1]
    sub_cat = message.text
    
    if sub_cat == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ":
        show_ad_main_categories(message)
        return
    
    cursor.execute("SELECT id, title FROM ads WHERE category_main = ? AND category_sub = ?", (main_cat, sub_cat))
    ads = cursor.fetchall()
    
    if ads:
        keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
        for ad in ads:
            keyboard.add(ad[1])
        keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø²ÛŒØ± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§")
        set_user_state(user_id, f'awaiting_ad_selection_{main_cat}_{sub_cat}')
        bot.send_message(user_id, "ğŸ“‹ Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=keyboard)
    else:
        bot.send_message(user_id, "â„¹ï¸ Ù‡ÛŒÚ† Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.", reply_markup=get_ads_management_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_ad_selection_'))
def show_selected_ad(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    parts = state.split('_')
    main_cat = parts[3]
    sub_cat = parts[4]
    title = message.text
    
    if title == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø²ÛŒØ± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§":
        show_ad_sub_categories_view(message)
        return
    
    cursor.execute("SELECT * FROM ads WHERE title = ? AND category_main = ? AND category_sub = ?", (title, main_cat, sub_cat))
    ad = cursor.fetchone()
    
    if ad:
        ad_id, user_id_owner, title, description, price, address, category_main, category_sub, photo_id, contact, created_at = ad
        response = f"ğŸ·ï¸ Ø¹Ù†ÙˆØ§Ù†: {title}\nğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {description}\nğŸ’° Ù‚ÛŒÙ…Øª: {price}\nğŸ“ Ø¢Ø¯Ø±Ø³: {address}\nğŸ“ ØªÙ…Ø§Ø³: {contact}\nğŸ“‚ Ø¯Ø³ØªÙ‡: {category_main} - {category_sub}"
        
        if photo_id:
            bot.send_photo(message.chat.id, photo_id, caption=response)
        else:
            bot.send_message(message.chat.id, response)
        
        if user_id == user_id_owner:
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´", callback_data=f"edit_ad_{ad_id}"))
            keyboard.add(types.InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù", callback_data=f"delete_ad_{ad_id}"))
            bot.send_message(message.chat.id, "âš™ï¸ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ú¯Ù‡ÛŒ:", reply_markup=keyboard)
    else:
        bot.send_message(message.chat.id, "â„¹ï¸ Ø¢Ú¯Ù‡ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
    
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()

@bot.message_handler(func=lambda message: message.text == "â• Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ú¯Ù‡ÛŒ")
def add_ad_main_categories(message):
    bot.send_message(message.chat.id, "ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_ad_main_categories_keyboard())
    set_user_state(message.from_user.id, 'awaiting_ad_main_cat_add')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_main_cat_add' and message.text in AD_CATEGORIES)
def add_ad_sub_categories(message):
    main_cat = message.text
    bot.send_message(message.chat.id, f"ğŸ“ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ '{main_cat}' Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.\nØ²ÛŒØ± Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_ad_sub_categories_keyboard(main_cat))
    set_user_state(message.from_user.id, f'awaiting_ad_sub_cat_add_{main_cat}')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_ad_sub_cat_add_'))
def get_ad_title_add(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    main_cat = state.split('_')[-1]
    sub_cat = message.text
    
    if sub_cat == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ":
        add_ad_main_categories(message)
        return
    
    set_user_state(user_id, 'awaiting_ad_title', {'category_main': main_cat, 'category_sub': sub_cat})
    bot.send_message(user_id, "ğŸ·ï¸ Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_title')
def get_ad_description(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['title'] = message.text.strip()
    if not data['title']:
        bot.send_message(user_id, "âš ï¸ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_ad_description', data)
    bot.send_message(user_id, "ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_description')
def get_ad_price(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['description'] = message.text.strip()
    if not data['description']:
        bot.send_message(user_id, "âš ï¸ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_ad_price', data)
    bot.send_message(user_id, "ğŸ’° Ù‚ÛŒÙ…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„):")

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_price')
def get_ad_address(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['price'] = message.text.strip()
    set_user_state(user_id, 'awaiting_ad_address', data)
    bot.send_message(user_id, "ğŸ“ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„):")

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_address')
def get_ad_contact(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['address'] = message.text.strip()
    set_user_state(user_id, 'awaiting_ad_contact', data)
    bot.send_message(user_id, "ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÛŒØ§ Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø§Ù„Ø²Ø§Ù…ÛŒ):")

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_contact')
def get_ad_photo(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    contact = message.text.strip()
    if not contact:
        bot.send_message(user_id, "âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    
    if contact.startswith("09") and len(contact) == 11 and contact.isdigit():
        data['contact'] = contact
    else:
        bot.send_message(user_id, "âš ï¸ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ùˆ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.")
        return
    
    set_user_state(user_id, 'awaiting_ad_photo', data)
    bot.send_message(user_id, "ğŸ“¸ Ø¹Ú©Ø³ Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ (Ø§Ù„Ø²Ø§Ù…ÛŒ):")

@bot.message_handler(content_types=['photo'], func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_ad_photo')
def process_ad_photo(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    photo_id = message.photo[-1].file_id
    data['photo_id'] = photo_id
    
    cursor.execute("INSERT INTO ads (user_id, title, description, price, address, category_main, category_sub, photo_id, contact) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
                   (user_id, data['title'], data['description'], data.get('price', ''), data.get('address', ''), data['category_main'], data['category_sub'], photo_id, data['contact']))
    conn.commit()
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()
    update_user_points(user_id, 10)
    bot.send_message(user_id, "âœ… Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ø´Ø¯ Ùˆ 10 Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÛŒØ¯!", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ“„ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†")
def show_my_ads(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, title, category_main, category_sub FROM ads WHERE user_id = ?", (user_id,))
    my_ads = cursor.fetchall()
    
    if my_ads:
        for ad in my_ads:
            ad_id, title, main_cat, sub_cat = ad
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´", callback_data=f"edit_ad_{ad_id}"))
            keyboard.add(types.InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù", callback_data=f"delete_ad_{ad_id}"))
            bot.send_message(user_id, f"ğŸ·ï¸ Ø¹Ù†ÙˆØ§Ù†: {title}\nğŸ“‚ Ø¯Ø³ØªÙ‡: {main_cat} - {sub_cat}", reply_markup=keyboard)
    else:
        bot.send_message(user_id, "â„¹ï¸ Ø´Ù…Ø§ Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", reply_markup=get_main_keyboard())

# Ø¨Ø®Ø´ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§
def handle_shops(message):
    bot.send_message(message.chat.id, "ğŸª Ø¨Ù‡ Ø¨Ø®Ø´ Ù…ØºØ§Ø²Ù‡ Ù‡Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=get_shops_management_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§")
def show_shop_main_categories(message):
    bot.send_message(message.chat.id, "ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_shop_main_categories_keyboard())
    set_user_state(message.from_user.id, 'awaiting_shop_main_cat_view')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_main_cat_view' and message.text in SHOP_CATEGORIES)
def show_shop_sub_categories_view(message):
    main_cat = message.text
    bot.send_message(message.chat.id, f"ğŸ“ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ '{main_cat}' Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.\nØ²ÛŒØ± Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_shop_sub_categories_keyboard(main_cat))
    set_user_state(message.from_user.id, f'awaiting_shop_sub_cat_view_{main_cat}')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_shop_sub_cat_view_'))
def show_shops_in_sub_cat(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    main_cat = state.split('_')[-1]
    sub_cat = message.text
    
    if sub_cat == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ":
        show_shop_main_categories(message)
        return
    
    cursor.execute("SELECT id, title FROM shops WHERE category_main = ? AND category_sub = ?", (main_cat, sub_cat))
    shops = cursor.fetchall()
    
    if shops:
        keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
        for shop in shops:
            keyboard.add(shop[1])
        keyboard.add("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø²ÛŒØ± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§")
        set_user_state(user_id, f'awaiting_shop_selection_{main_cat}_{sub_cat}')
        bot.send_message(user_id, "ğŸ“‹ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=keyboard)
    else:
        bot.send_message(user_id, "â„¹ï¸ Ù‡ÛŒÚ† Ù…ØºØ§Ø²Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.", reply_markup=get_shops_management_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_shop_selection_'))
def show_selected_shop(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    parts = state.split('_')
    main_cat = parts[3]
    sub_cat = parts[4]
    title = message.text
    
    if title == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø²ÛŒØ± Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§":
        show_shop_sub_categories_view(message)
        return
    
    cursor.execute("SELECT * FROM shops WHERE title = ? AND category_main = ? AND category_sub = ?", (title, main_cat, sub_cat))
    shop = cursor.fetchone()
    
    if shop:
        (shop_id, title, description, address, category_main, category_sub, 
         photo_id, contact, admin_id, owner_id, seller_username, seller_age, seller_gender, created_at) = shop
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§
        cursor.execute("SELECT AVG(rating) FROM shop_ratings WHERE shop_id = ?", (shop_id,))
        avg_rating = cursor.fetchone()[0] or 0
        
        response = (f"ğŸª Ø¹Ù†ÙˆØ§Ù†: {title}\n"
                   f"ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {description}\n"
                   f"ğŸ“ Ø¢Ø¯Ø±Ø³: {address}\n"
                   f"ğŸ“ ØªÙ…Ø§Ø³: {contact}\n"
                   f"ğŸ‘¤ ÙØ±ÙˆØ´Ù†Ø¯Ù‡: {seller_username} (Ø³Ù†: {seller_age}, Ø¬Ù†Ø³ÛŒØª: {seller_gender})\n"
                   f"ğŸ“‚ Ø¯Ø³ØªÙ‡: {category_main} - {category_sub}\n"
                   f"â­ Ø§Ù…ØªÛŒØ§Ø²: {avg_rating:.1f}/10")
        
        if photo_id:
            bot.send_photo(message.chat.id, photo_id, caption=response)
        else:
            bot.send_message(message.chat.id, response)
        
        # Ø¯Ú©Ù…Ù‡ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ
        keyboard = types.InlineKeyboardMarkup()
        keyboard.add(types.InlineKeyboardButton("â­ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø¯Ù†", callback_data=f"rate_shop_{shop_id}"))
        bot.send_message(message.chat.id, "âš™ï¸ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:", reply_markup=keyboard)
    else:
        bot.send_message(message.chat.id, "â„¹ï¸ Ù…ØºØ§Ø²Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
    
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()

@bot.message_handler(func=lambda message: message.text == "â• Ø§ÙØ²ÙˆØ¯Ù† Ù…ØºØ§Ø²Ù‡")
def check_add_shop_permission(message):
    if message.from_user.id == ADMIN_ID:
        bot.send_message(message.from_user.id, "ğŸ“‚ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_shop_main_categories_keyboard())
        set_user_state(message.from_user.id, 'awaiting_shop_main_cat_add')
    else:
        bot.send_message(message.from_user.id, "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù…ØºØ§Ø²Ù‡ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯: @Sedayegoyom10", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_main_cat_add' and message.text in SHOP_CATEGORIES)
def add_shop_sub_categories(message):
    main_cat = message.text
    bot.send_message(message.chat.id, f"ğŸ“ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ '{main_cat}' Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯.\nØ²ÛŒØ± Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_shop_sub_categories_keyboard(main_cat))
    set_user_state(message.from_user.id, f'awaiting_shop_sub_cat_add_{main_cat}')

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] and get_user_state(message.from_user.id)[0].startswith('awaiting_shop_sub_cat_add_'))
def get_shop_title_add(message):
    user_id = message.from_user.id
    state, _ = get_user_state(user_id)
    main_cat = state.split('_')[-1]
    sub_cat = message.text
    
    if sub_cat == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ":
        check_add_shop_permission(message)
        return
    
    set_user_state(user_id, 'awaiting_shop_title', {'category_main': main_cat, 'category_sub': sub_cat})
    bot.send_message(user_id, "ğŸ·ï¸ Ø¹Ù†ÙˆØ§Ù† Ù…ØºØ§Ø²Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_title' and message.from_user.id == ADMIN_ID)
def get_shop_description(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['title'] = message.text.strip()
    if not data['title']:
        bot.send_message(user_id, "âš ï¸ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_shop_description', data)
    bot.send_message(user_id, "ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…ØºØ§Ø²Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_description' and message.from_user.id == ADMIN_ID)
def get_shop_address(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['description'] = message.text.strip()
    if not data['description']:
        bot.send_message(user_id, "âš ï¸ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_shop_address', data)
    bot.send_message(user_id, "ğŸ“ Ø¢Ø¯Ø±Ø³ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_address' and message.from_user.id == ADMIN_ID)
def get_shop_contact(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    data['address'] = message.text.strip()
    if not data['address']:
        bot.send_message(user_id, "âš ï¸ Ø¢Ø¯Ø±Ø³ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    set_user_state(user_id, 'awaiting_shop_contact', data)
    bot.send_message(user_id, "ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_contact' and message.from_user.id == ADMIN_ID)
def get_shop_owner_id(message):
    user_id = message.from_user.id
    contact = message.text.strip()
    if not contact:
        bot.send_message(user_id, "âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    
    if not (contact.startswith("09") and len(contact) == 11 and contact.isdigit()):
        bot.send_message(user_id, "âš ï¸ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ùˆ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯.")
        return
    
    state, data = get_user_state(user_id)
    data['contact'] = contact
    set_user_state(user_id, 'awaiting_shop_owner_id', data)
    bot.send_message(user_id, "ğŸ”¢ Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØµØ§Ø­Ø¨ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=get_back_to_admin_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_owner_id' and message.from_user.id == ADMIN_ID)
def get_seller_username(message):
    user_id = message.from_user.id
    try:
        owner_id = int(message.text.strip())
        cursor.execute("SELECT username, age, gender FROM users WHERE random_id = ?", (owner_id,))
        owner_data = cursor.fetchone()
        
        if not owner_data:
            bot.send_message(user_id, "âš ï¸ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return
        
        state, data = get_user_state(user_id)
        data['owner_id'] = owner_id
        data['seller_username'] = owner_data[0]
        data['seller_age'] = owner_data[1]
        data['seller_gender'] = owner_data[2]
        data['admin_id'] = user_id
        
        set_user_state(user_id, 'awaiting_shop_photo', data)
        bot.send_message(user_id, "ğŸ“¸ Ø¹Ú©Ø³ Ù…ØºØ§Ø²Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ (Ø§Ù„Ø²Ø§Ù…ÛŒ):", reply_markup=get_back_to_admin_keyboard())
    except:
        bot.send_message(user_id, "âš ï¸ Ø´Ù†Ø§Ø³Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.")

@bot.message_handler(content_types=['photo'], func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_shop_photo' and message.from_user.id == ADMIN_ID)
def process_shop_photo(message):
    user_id = message.from_user.id
    state, data = get_user_state(user_id)
    photo_id = message.photo[-1].file_id
    
    cursor.execute("""INSERT INTO shops (title, description, address, category_main, category_sub, 
                   photo_id, contact, admin_id, owner_id, seller_username, seller_age, seller_gender) 
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)""",
                   (data['title'], data['description'], data['address'], data['category_main'], 
                    data['category_sub'], photo_id, data['contact'], data['admin_id'], data['owner_id'],
                    data['seller_username'], data['seller_age'], data['seller_gender']))
    conn.commit()
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()
    bot.send_message(user_id, "âœ… Ù…ØºØ§Ø²Ù‡ Ø«Ø¨Øª Ø´Ø¯.", reply_markup=get_admin_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ“„ Ù…ØºØ§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†")
def show_my_shops(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, title, category_main, category_sub FROM shops WHERE owner_id = (SELECT random_id FROM users WHERE user_id = ?)", (user_id,))
    my_shops = cursor.fetchall()
    
    if my_shops:
        for shop in my_shops:
            shop_id, title, main_cat, sub_cat = shop
            bot.send_message(user_id, f"ğŸª Ø¹Ù†ÙˆØ§Ù†: {title}\nğŸ“‚ Ø¯Ø³ØªÙ‡: {main_cat} - {sub_cat}")
    else:
        bot.send_message(user_id, "â„¹ï¸ Ø´Ù…Ø§ Ù…ØºØ§Ø²Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", reply_markup=get_main_keyboard())

# Ø¨Ø®Ø´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
def show_profile(message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)
    if user_data:
        _, username, age, gender, points, rand_id, _ = user_data
        response = (f"ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:\n"
                   f"ğŸ·ï¸ Ù†Ø§Ù…: {username}\n"
                   f"ğŸ”¢ Ø´Ù†Ø§Ø³Ù‡: {rand_id}\n"
                   f"ğŸ‚ Ø³Ù†: {convert_fa_numbers(str(age))}\n"
                   f"ğŸ‘« Ø¬Ù†Ø³ÛŒØª: {gender}\n"
                   f"â­ Ø§Ù…ØªÛŒØ§Ø²: {points}")
        bot.send_message(user_id, response, reply_markup=get_profile_keyboard())

@bot.message_handler(func=lambda message: message.text == "âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ âœï¸")
def edit_profile_menu(message):
    bot.send_message(message.chat.id, "âš™ï¸ Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯ØŸ", reply_markup=get_edit_profile_keyboard())

@bot.message_handler(func=lambda message: message.text == "âœï¸ ØªØºÛŒÛŒØ± Ø§Ø³Ù…")
def change_username_start(message):
    set_user_state(message.from_user.id, 'awaiting_new_username')
    bot.send_message(message.chat.id, "âœï¸ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_new_username')
def change_username_process(message):
    user_id = message.from_user.id
    new_username = message.text.strip()
    if not new_username:
        bot.send_message(user_id, "âš ï¸ Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    cursor.execute("UPDATE users SET username = ? WHERE user_id = ?", (new_username, user_id))
    conn.commit()
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()
    bot.send_message(user_id, f"âœ… Ù†Ø§Ù… Ø´Ù…Ø§ Ø¨Ù‡ {new_username} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "âœï¸ ØªØºÛŒÛŒØ± Ø³Ù†")
def change_age_start(message):
    set_user_state(message.from_user.id, 'awaiting_new_age')
    keyboard = types.ReplyKeyboardMarkup(row_width=10, resize_keyboard=True)
    ages = [str(i) for i in range(13, 71)]
    keyboard.add(*ages)
    bot.send_message(message.chat.id, "ğŸ‚ Ø³Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=keyboard)

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_new_age')
def change_age_process(message):
    user_id = message.from_user.id
    try:
        new_age = int(message.text)
        if 13 <= new_age <= 70:
            cursor.execute("UPDATE users SET age = ? WHERE user_id = ?", (new_age, user_id))
            conn.commit()
            cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
            conn.commit()
            bot.send_message(user_id, f"âœ… Ø³Ù† Ø´Ù…Ø§ Ø¨Ù‡ {convert_fa_numbers(str(new_age))} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.", reply_markup=get_main_keyboard())
        else:
            bot.send_message(user_id, "âš ï¸ Ø³Ù† Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 13 ØªØ§ 70 Ø¨Ø§Ø´Ø¯:")
    except ValueError:
        bot.send_message(user_id, "âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")

@bot.message_handler(func=lambda message: message.text == "âœï¸ ØªØºÛŒÛŒØ± Ø¬Ù†Ø³ÛŒØª")
def change_gender_start(message):
    set_user_state(message.from_user.id, 'awaiting_new_gender')
    bot.send_message(message.chat.id, "ğŸ‘« Ø¬Ù†Ø³ÛŒØª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_gender_keyboard())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_new_gender')
def change_gender_process(message):
    user_id = message.from_user.id
    new_gender = message.text
    if new_gender in ["ğŸ‘¦ Ù¾Ø³Ø±", "ğŸ‘§ Ø¯Ø®ØªØ±"]:
        gender_text = "Ù¾Ø³Ø±" if "Ù¾Ø³Ø±" in new_gender else "Ø¯Ø®ØªØ±"
        cursor.execute("UPDATE users SET gender = ? WHERE user_id = ?", (gender_text, user_id))
        conn.commit()
        cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
        conn.commit()
        bot.send_message(user_id, f"âœ… Ø¬Ù†Ø³ÛŒØª Ø´Ù…Ø§ Ø¨Ù‡ {gender_text} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.", reply_markup=get_main_keyboard())
    else:
        bot.send_message(user_id, "âš ï¸ Ù„Ø·ÙØ§Ù‹ 'Ù¾Ø³Ø±' ÛŒØ§ 'Ø¯Ø®ØªØ±' Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=get_gender_keyboard())

@bot.message_handler(func=lambda message: message.text == "â­ Ú¯ÙˆÛŒÙ…ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± â­")
def show_top_users(message):
    cursor.execute("SELECT username, age, gender, points FROM users WHERE points > 1000 ORDER BY points DESC LIMIT 10")
    top_users = cursor.fetchall()
    if top_users:
        response = "ğŸ† Ú¯ÙˆÛŒÙ…ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ±:\n\n"
        for i, user in enumerate(top_users, 1):
            response += f"{i}. ğŸ‘¤ {user[0]} - ğŸ‚ {user[1]} - ğŸ‘« {user[2]} - â­ {user[3]}\n"
    else:
        response = "â„¹ï¸ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§Ù„Ø§ÛŒ 1000 ÛŒØ§ÙØª Ù†Ø´Ø¯."
    bot.send_message(message.chat.id, response, reply_markup=get_main_keyboard())

# Ø¨Ø®Ø´ Ø·Ù†Ø²
def handle_jokes(message):
    bot.send_message(message.chat.id, "ğŸ˜‚ Ø¨Ù‡ Ø¨Ø®Ø´ Ø·Ù†Ø² Ùˆ Ø®Ø§Ø·Ø±Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=get_jokes_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ“œ Ù„ÛŒØ³Øª Ø·Ù†Ø²Ù‡Ø§")
def show_all_jokes(message):
    cursor.execute("SELECT id, joke_text FROM jokes LIMIT 10")
    jokes = cursor.fetchall()
    if jokes:
        for joke in jokes:
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("ğŸ“– Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„", callback_data=f"show_joke_{joke[0]}"))
            bot.send_message(message.chat.id, joke[1][:100] + "...", reply_markup=keyboard)
    else:
        bot.send_message(message.chat.id, "â„¹ï¸ Ù‡ÛŒÚ† Ø·Ù†Ø²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "â• Ø§ÙØ²ÙˆØ¯Ù† Ø·Ù†Ø²")
def handle_add_joke(message):
    user_id = message.from_user.id
    set_user_state(user_id, 'awaiting_joke')
    bot.send_message(user_id, "ğŸ˜‚ Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø·Ù†Ø² ÛŒØ§ Ø®Ø§Ø·Ø±Ù‡ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=types.ReplyKeyboardRemove())

@bot.message_handler(func=lambda message: get_user_state(message.from_user.id)[0] == 'awaiting_joke')
def process_add_joke(message):
    user_id = message.from_user.id
    joke_text = message.text.strip()
    if not joke_text:
        bot.send_message(user_id, "âš ï¸ Ù…ØªÙ† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    cursor.execute("INSERT INTO jokes (user_id, joke_text) VALUES (?, ?)", (user_id, joke_text))
    conn.commit()
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()
    update_user_points(user_id, 5)
    bot.send_message(user_id, "âœ… Ø·Ù†Ø² Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ 5 Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÛŒØ¯!", reply_markup=get_main_keyboard())

@bot.message_handler(func=lambda message: message.text == "ğŸ“„ Ø·Ù†Ø²Ù‡Ø§ÛŒ Ù…Ù†")
def show_my_jokes(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, joke_text FROM jokes WHERE user_id = ?", (user_id,))
    my_jokes = cursor.fetchall()
    if my_jokes:
        for joke in my_jokes:
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´", callback_data=f"edit_joke_{joke[0]}"))
            keyboard.add(types.InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù", callback_data=f"delete_joke_{joke[0]}"))
            bot.send_message(user_id, joke[1], reply_markup=keyboard)
    else:
        bot.send_message(user_id, "â„¹ï¸ Ø´Ù…Ø§ Ø·Ù†Ø²ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", reply_markup=get_main_keyboard())

# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª
@bot.message_handler(func=lambda message: message.text in ["â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ…", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ØºØ§Ø²Ù‡ Ù‡Ø§", "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„"])
def handle_back_buttons(message):
    user_id = message.from_user.id
    if message.text == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ Ø§ØµÙ„ÛŒ":
        bot.send_message(user_id, "ğŸ  Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.", reply_markup=get_main_keyboard())
    elif message.text == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯ÛŒÙˆØ§Ø± Ú¯ÙˆÛŒÙ…":
        handle_divar(message)
    elif message.text == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ØºØ§Ø²Ù‡ Ù‡Ø§":
        handle_shops(message)
    elif message.text == "â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„":
        show_profile(message)
    
    cursor.execute("DELETE FROM user_states WHERE user_id = ?", (user_id,))
    conn.commit()

# Ù‡Ù†Ø¯Ù„Ø± Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)
    if user_data:
        state, _ = get_user_state(user_id)
        if not state:
            bot.send_message(user_id, "â„¹ï¸ Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.", reply_markup=get_main_keyboard())
        else:
            bot.send_message(user_id, "â„¹ï¸ Ù„Ø·ÙØ§Ù‹ Ù…Ø±Ø§Ø­Ù„ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯.")
    else:
        send_welcome(message)

# Webhook setup
if WEBHOOK_URL:
    bot.remove_webhook()
    bot.set_webhook(url=WEBHOOK_URL)

@app.route(f'/{API_TOKEN}', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return 'OK', 200
    else:
        return 'Invalid Content-Type', 403

@app.route('/')
def index():
    return 'Goyom Bot is running!'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.getenv('PORT', 5000)))